version: "3.4"

services:
  nginx:
    build:
      context: ./nginx
    command: ["nginx-debug", "-g", "daemon off;"]

  redis:
    image: redis:5.0.4
    container_name: cache
    expose:
      - 6379

  kiwi-iam:
    build:
      args:
        - GITLAB_USERNAME
        - GITLAB_PASSWORD
      context: ../../
    env_file:
      - iam.env
    environment:
      REDIS_HOST: ${REDIS_HOST:-cache}
    links:
      - redis
      - nginx
    expose:
      - 8080
    depends_on:
      - nginx
      - redis

  venom:
    build:
      context: ./venom
    environment:
      IAM_URL: http://kiwi-iam:8080
    links:
      - kiwi-iam:kiwi-iam
    depends_on:
      - kiwi-iam
